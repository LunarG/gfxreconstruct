# Using the Vulkan GFXReconstruct Layer in Android

## Before Use

### Permissions

You will need to grant permissions to your application to write to
system storage, even if it normally does not.
This is due to the fact that the GFXReconstruct layer generates a
capture file which is written out to the `/sdcard` folder by default.

If you're building with Android Studio, you do this by:
 * Click on "Run" in the menu
 * Choose "Edit Configurations..."
 * In the dialog box, look for the "Install Flags:" text box
 * Enter `-g`
 * Click "Apply"

If this does not work, you may still require enabling permissions for
your application from the settings menu.

**Failure to do so** will result in your application crashign during `vkCreateInstance`
since the layer will attempt, but fail, to create the capture file.

### Disabling Memory Tracking Seg-Faults

The GFXReconstruct layer sometimes uses page table faults to properly
track memory usage by an application.
Because of this, the SIGSEGV page fault event can cause unnecessary
breaking when stepping through a debugger while your application is
running.

To work around this, you can use the following command to stop the
debugger from breaking on SIGSEGVs generated by the capture layer's
memory tracking:

```
process handle SIGSEGV -n true -p true -s false
```

This can be entered manually through the LLDB tab on Android Studio's
Debug panel.

It can also be set as a post launch command in the project configuration:

```
Run > Edit Configurations...
```

Then choosing:

```
Debugger > LLDP Post Attach Commands
```

Where you can click the `+` and add it manually.



## Globally Enabling the Layer

Use ADB to enable the layer for your project by:

```
adb shell "setprop debug.vulkan.layers 'VK_LAYER_LUNARG_gfxreconstruct'"
```

When done, disable the layer using:

```
adb shell "setprop debug.vulkan.layers ''"
```

## Capture Files

By default, capture files are dumped out to the `/sdcard`, and will
use the name `gfxrecon_capture.gfxr`:

 ```
/sdcard/gfxrecon_capture.gfxr
```

Enabling timestamps may be needed since many applications create Vulkan items in
one thread to validate available functionality.
Those same apps, then exit that thread, and start a new thread creating items.
Some applications even create additional Vulkan items after the main functionality
has completed which can result in overwritten capture data.


### Overriding the Default Name

You may override the name and location of the capture file by setting the
property `debug.gfxrecon.capture_file` to point to what you would like to
output.

This may be done by performed by using `adb shell` in the following way:

```
adb shell "setprop debug.gfxrecon.capture_file '<your_path_and_file_name_here>.gfxr'"
```

### Timestamps

If you enable file timestamps, this file will actually be created new every
call based on the time the application first access the layer in its
`vkCreateInstance` call:

 ```
/sdcard/gfxrecon_capture_yyyymmddThhmmss.gfxr
```

Where the lower-case letters stand for: Year, Month, Day, Hour, Minute, Second.
The `T` is left alone to indicate that this is a date/time.

For example:  `gfxrecon_capture_20181125T083227.gfxr`

