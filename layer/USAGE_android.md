# Using the Vulkan GFXReconstruct Layer in Android

## Before Use

### Permissions

You will need to grant permissions to your application to write to
system storage, even if it normally does not.
This is due to the fact that the GFXReconstruct layer generates a
capture file which is written out to the `/sdcard` folder by default.

If you're building with Android Studio, you do this by:
 * Click on "Run" in the menu
 * Choose "Edit Configurations..."
 * In the dialog box, look for the "Install Flags:" text box
 * Enter `-g`
 * Click "Apply"

If this does not work, you may still require enabling permissions for
your application from the settings menu.

**Failure to do so** will result in your application crashign during `vkCreateInstance`
since the layer will attempt, but fail, to create the capture file.

### Disabling Memory Tracking Seg-Faults

The GFXReconstruct layer sometimes uses page table faults to properly
track memory usage by an application.
Because of this, the SIGSEGV page fault event can cause unnecessary
breaking when stepping through a debugger while your application is
running.

To work around this, you can use the following command to stop the
debugger from breaking on SIGSEGVs generated by the capture layer's
memory tracking:

```
process handle SIGSEGV -n true -p true -s false
```

This can be entered manually through the LLDB tab on Android Studio's
Debug panel.

It can also be set as a post launch command in the project configuration:

```
Run > Edit Configurations...
```

Then choosing:

```
Debugger > LLDP Post Attach Commands
```

Where you can click the `+` and add it manually.

<br></br>

## Globally Enabling the Layer

Use ADB to enable the layer for your project by:

```
adb shell "setprop debug.vulkan.layers 'VK_LAYER_LUNARG_gfxreconstruct'"
```

When done, disable the layer using:

```
adb shell "setprop debug.vulkan.layers ''"
```

<br></br>

## GFXRecon Debug Options

THe GFXReconstruct has multiple options that can be adjusted by using
Android properties.
Each property **must** begin with the prefix `debug.gfxrecon.`.
This may be done by performed by using `adb shell` in the following way:

```
adb shell "setprop <option> '<value>'"
```

For example, to set the log_level to "warning", you would call:

```
adb shell "setprop debug.gfxrecon.log_level 'warning'"
```

<br></br>

Option | Property | Type | Description
------| ------------- |------|-------------
Capture Compression Type | debug.gfxrecon.capture_compression_type | STRING | Define a specific compression type to use when capturing content.  Valid values are: "LZ4", "ZLIB", and "NONE".
Capture File | debug.gfxrecon.capture_file | STRING | This option allows you to override the default path and name of the capture file.
Capture File Timestamp | debug.gfxrecon.capture_file_timestamp | BOOL | This option lets you indicate if you want the capture file name to include the timestamp at creation time. This is important if your application could generate more than one and would normally clobber the original file's contents.
Log Allow Indents | debug.gfxrecon.log_allow_indents | BOOL | This is an option to allow indent formatting in the strings to attempt to make things easier to read. Although indenting is used in very limited circumstances currently.
Log Break On Error | debug.gfxrecon.log_break_on_error | BOOL | This option allows you to force the layer to break if it encounters an error so you can debug it easily.
Log Detailed | debug.gfxrecon.log_detailed | BOOL | Enable detailed logging messages (includes file name and location where triggered from).
Errors To Stderr | debug.gfxrecon.log_errors_to_stderr | BOOL | This option allows you to force all error messages that would be normally logged to also output to stderr.
Log File | debug.gfxrecon.log_file | STRING | This option allows you to define the path and name of a log file that will be generated with log messages.
Log File Create New | debug.gfxrecon.log_file_create_new | BOOL | This option indicates that you want to either create a new file every time the layer is triggered, or append to the old log file.
Log File Flush After Write | debug.gfxrecon.log_file_flush_after_write | BOOL | This option allows you to force a flush after every log file write to make sure you don't loose messages in a buffer.
Log File Keep Open | debug.gfxrecon.log_file_keep_open | BOOL | This option forces the log file to remain open after it's created to allow for faster recording of log messages.
Log Level | debug.gfxrecon.log_level | STRING | This option allows you to choose what log level you desire to trigger.  Available options include: "debug", "info", "warning", "error", and "fatal".  Any level selected will include all levels listed after it.  For example, choosing "warning" will also log out "error" and "fatal" messages.
Log Output To Console | debug.gfxrecon.log_output_to_console | BOOL | This option allows log messages to be written out to stdout (or whatever debug console is available on the target platform.
Memory Tracking Mode | debug.gfxrecon.memory_tracking_mode | STRING | This option allows the user to determine what memory tracking mode the layer uses when handling memory.  Available options are: "page_guard", "assisted" and "unassisted".  <ul><li>"unassisted" assumes the application does not flush, so writes all mapped data on an `vkUnmapMemory` or `vkQueueSubmit` call.</li> <li>"assisted" assumes the application will always flush after writing to mapped memory, so will only write on a flush.</li> <li>"page_guard" is used to determine which regions of memory to write on an `vkUnmapMemory` or `vkQueueSubmit` call.  "page_guard" also shadows uncached memory so as to properly provide all memory it can.</li></ul>

<br></br>

## Capture Files

By default, capture files are dumped out to the `/sdcard`, and will
use the name `gfxrecon_capture.gfxr`:

 ```
/sdcard/gfxrecon_capture.gfxr
```

Enabling timestamps may be needed since many applications create Vulkan items in
one thread to validate available functionality.
Those same apps, then exit that thread, and start a new thread creating items.
Some applications even create additional Vulkan items after the main functionality
has completed which can result in overwritten capture data.


### Overriding the Default Name

You may override the name and location of the capture file by setting the
property `debug.gfxrecon.capture_file` to point to what you would like to
output as defined above in [GFXRecon Debug Options](#gfxrecon-debug-options).

This may be done by performed by using `adb shell` in the following way:

```
adb shell "setprop debug.gfxrecon.capture_file '<your_path_and_file_name_here>.gfxr'"
```

### Timestamps

If you enable file timestamps, this file will actually be created new every
call based on the time the application first access the layer in its
`vkCreateInstance` call:

 ```
/sdcard/gfxrecon_capture_yyyymmddThhmmss.gfxr
```

Where the lower-case letters stand for: Year, Month, Day, Hour, Minute, Second.
The `T` is left alone to indicate that this is a date/time.

For example:  `gfxrecon_capture_20181125T083227.gfxr`

