# Using the Vulkan GFXReconstruct Layer in Android

## Before Use

### Permissions

You will need to grant permissions to your application to write to
system storage, even if it normally does not.
This is due to the fact that the GFXReconstruct layer generates a
capture file which is written out to the `/sdcard` folder by default.

If you're building with Android Studio, you do this by:
 * Click on "Run" in the menu
 * Choose "Edit Configurations..."
 * In the dialog box, look for the "Install Flags:" text box
 * Enter `-g`
 * Click "Apply"

If this does not work, you may still require enabling permissions for
your application from the settings menu.

**Failure to do so** will result in your application crashign during `vkCreateInstance`
since the layer will attempt, but fail, to create the capture file.

### Disabling Memory Tracking Seg-Faults

The GFXReconstruct layer sometimes uses page table faults to properly
track memory usage by an application.
Because of this, the SIGSEGV page fault event can cause unnecessary
breaking when stepping through a debugger while your application is
running.

To work around this, you can use the following command to stop the
debugger from breaking on SIGSEGVs generated by the capture layer's
memory tracking:

```
process handle SIGSEGV -n true -p true -s false
```

This can be entered manually through the LLDB tab on Android Studio's
Debug panel.

It can also be set as a post launch command in the project configuration:

```
Run > Edit Configurations...
```

Then choosing:

```
Debugger > LLDP Post Attach Commands
```

Where you can click the `+` and add it manually.

<br></br>

## Globally Enabling the Layer

Use ADB to enable the layer for your project by:

```
adb shell "setprop debug.vulkan.layers 'VK_LAYER_LUNARG_gfxreconstruct'"
```

When done, disable the layer using:

```
adb shell "setprop debug.vulkan.layers ''"
```

<br></br>

## GFXRecon Debug Options

THe GFXReconstruct has multiple options that can be adjusted by using
Android properties.
Each property **must** begin with the prefix `debug.gfxrecon.`.
This may be done by performed by using `adb shell` in the following way:

```
adb shell "setprop <option> '<value>'"
```

For example, to set the log_level to "warning", you would call:

```
adb shell "setprop debug.gfxrecon.log_level 'warning'"
```

<br></br>

[//]: # (BEGIN-CODE-GEN - DO NOT REMOVE THIS COMMENT, THE FOLLOWING CODE IS AUTO-GENERATED)
Option | Property | Type | Description
------ | ------------- | ------ | -------------
Capture Compression Type | debug.gfxrecon.capture_compression_type | string | Define a specific compression type to use when capturing content.Valid values are: "lz4", "lz77", "none".<ul><li>"lz4" - LZ4 lossless compression</li><li>"lz77" - LZ77 lossless compression</li><li>"none" - No compression</li></ul>
Capture File | debug.gfxrecon.capture_file | file/path | Overrides the default path and name of the capture file.
Capture File Timestamp | debug.gfxrecon.capture_file_timestamp | bool | Indicate if you want the capture file name to include the timestamp at creation time. This is important if your application could generate more than one and would normally clobber the original file's contents.
Capture Force Flush | debug.gfxrecon.capture_force_flush | bool | Indicate if you want to flush the contents of the capture file at the end of each generated API Call packet.
Log Allow Indents | debug.gfxrecon.log_allow_indents | bool | Apply iindent formatting in the strings to attempt to make things easier to read. Although indenting is used in very limited circumstances currently.
Log Break On Error | debug.gfxrecon.log_break_on_error | bool | Force the layer to break if it encounters an error so you can debug it easily.
Log Detailed | debug.gfxrecon.log_detailed | bool | Enable detailed logging messages (includes file name and location where triggered from).
Log Errors To Stderr | debug.gfxrecon.log_errors_to_stderr | bool | Redirect errors to stderr instead of stdout when writing to the console.
Log File | debug.gfxrecon.log_file | file/path | Output all log information to a file in the given location. Can be empty resulting in no log file.  Does not affect console output.
Log File Create New | debug.gfxrecon.log_file_create_new | bool | Allow the layer to create a new log file every time it starts, or to append to the existing file.
Log File Flush After Write | debug.gfxrecon.log_file_flush_after_write | bool | Flush the log file after every write.
Log File Keep Open | debug.gfxrecon.log_file_keep_open | bool | Keep the log file open between writes, otherwise open and close it every message.
Log Level | debug.gfxrecon.log_level | string | This option allows you to choose what log level you desire to trigger.Valid values are: "command", "debug", "info", "warning", "error", "fatal".<ul><li>"command" - Output log messages of all severities including command enter/exit messages</li><li>"debug" - Output log messages of Debug severity or higher</li><li>"info" - Output log messages of Info severity or higher</li><li>"warning" - Output log messages of Warning severity or higher</li><li>"error" - Output log messages of Error severity or higher</li><li>"fatal" - Output only fatal error log messages</li></ul>
Log Output To Console | debug.gfxrecon.log_output_to_console | bool | Output log messages to the console using stdout (or a platform appropriate version of console output).
Log Output To Os Debug String | debug.gfxrecon.log_output_to_os_debug_string | bool | Output log messages to an OS-specific logging mechanism. Currently only works for Windows, but allows debug messages to re-direct from the console to `OutputDebugStringA`.
Memory Tracking Mode | debug.gfxrecon.memory_tracking_mode | string | Define the memory tracking mode the layer uses when handling memory.Valid values are: "unassisted", "assisted", "page_guard".<ul><li>"unassisted" - Assumes the application does not flush, so writes all mapped data on an `vkUnmapMemory` or `vkQueueSubmit` call.</li><li>"assisted" - Assumes the application will always flush after writing to mapped memory, so will only write on a flush.</li><li>"page_guard" - Determine which regions of memory to write on an `vkUnmapMemory` or `vkQueueSubmit` call and shadows uncached memory so as to properly provide all memory it can.</li></ul>
[//]: # (END-CODE-GEN - DO NOT REMOVE THIS COMMENT, THE PRECEDING CODE IS AUTO-GENERATED)

<br></br>

## Capture Files

By default, capture files are dumped out to the `/sdcard`, and will
use the name `gfxrecon_capture.gfxr`:

 ```
/sdcard/gfxrecon_capture.gfxr
```

Enabling timestamps may be needed since many applications create Vulkan items in
one thread to validate available functionality.
Those same apps, then exit that thread, and start a new thread creating items.
Some applications even create additional Vulkan items after the main functionality
has completed which can result in overwritten capture data.


### Overriding the Default Name

You may override the name and location of the capture file by setting the
property `debug.gfxrecon.capture_file` to point to what you would like to
output as defined above in [GFXRecon Debug Options](#gfxrecon-debug-options).

This may be done by performed by using `adb shell` in the following way:

```
adb shell "setprop debug.gfxrecon.capture_file '<your_path_and_file_name_here>.gfxr'"
```

### Timestamps

If you enable file timestamps, this file will actually be created new every
call based on the time the application first access the layer in its
`vkCreateInstance` call:

 ```
/sdcard/gfxrecon_capture_yyyymmddThhmmss.gfxr
```

Where the lower-case letters stand for: Year, Month, Day, Hour, Minute, Second.
The `T` is left alone to indicate that this is a date/time.

For example:  `gfxrecon_capture_20181125T083227.gfxr`

