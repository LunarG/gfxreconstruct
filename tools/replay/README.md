# GFXReconstruct Replay Tool

The GFXReconstruct Replay tool (`gfxrecon-replay`) can be used to replay
files captured with or generated by other GFXReconstruct components.

## Desktop Usage
### Command Line Arguments
The `gfxrecon-replay` tool for Desktop accepts the following command line arguments:

```
gfxrecon-replay         [--version] [--gpu <index>] [--pause-frame <N>]
                        [--paused] [--sfa | --skip-failed-allocations]
                        [--replace-shaders <dir>]
                        [--opcd | --omit-pipeline-cache-data] [--wsi <platform>]
                        [-m <mode> | --memory-translation <mode>] <file>

Required arguments:
  <file>                Path to the capture file to replay.

Optional arguments:
  --version             Print version information and exit.
  --gpu <index>         Use the specified device for replay, where index
                        is the zero-based index to the array of physical devices
                        returned by vkEnumeratePhysicalDevices.  Replay may fail
                        if the specified device is not compatible with the
                        original capture devices.
  --pause-frame <N>     Pause after replaying frame number N.
  --paused              Pause after replaying the first frame (same
                        as --pause-frame 1).
  --sfa                 Skip vkAllocateMemory, vkAllocateCommandBuffers, and
                        vkAllocateDescriptorSets calls that failed during
                        capture (same as --skip-failed-allocations).
  --replace-shaders <dir> Replace the shader code in each CreateShaderModule
                        with the contents of the file <dir>/sh<hash> if found, where
                        <hash> is the xor sum of the original shader code.
  --opcd                Omit pipeline cache data from calls to
                        vkCreatePipelineCache (same as --omit-pipeline-cache-data).
  --wsi <platform>      Force replay to use the specified wsi platform.
                        Available platforms are: auto,win32,xcb,wayland
  -m <mode>             Enable memory translation for replay on GPUs with memory
                        types that are not compatible with the capture GPU's
                        memory types.  Available modes are:
                            none        No memory translation is performed.  This
                                        is the default behavior.
                            remap       Attempt to map capture memory types to
                                        compatible replay memory types, without
                                        altering memory allocation behavior.
                            rebind      Change memory allocation behavior based
                                        on resource usage and replay memory
                                        properties.  Resources may be bound
                                        to different allocations with different
                                        offsets.  Uses VMA to manage allocations
                                        and suballocations.
```
### Keyboard Controls
The `gfxrecon-replay` tool for Desktop supports the following key controls:

Key(s) | Action
-------|-------
Space, p | Toggle pause/play.
Right arrow, n | Advance to the next frame when paused.

## Android Usage
### Intent Extras
Command line arguments can be provided to the `gfxrecon-replay` tool through an
Android Intent extra. All command line arguments supported by the Desktop replay
tool are supported by the Android replay tool.  Command line arguments are provided
to the `am start` command with the following option:
```
--es "args" "<arg-string>"
```
Example `am start` command to play a file named `/sdcard/test.gfxr` and pause at frame 300:
```
adb shell am start -n "com.lunarg.gfxreconstruct.replay/android.app.NativeActivity" -a android.intent.action.MAIN -c android.intent.category.LAUNCHER --es "args" "--pause-frame 300 /sdcard/test.gfxr"
```

### Touch Controls
The `gfxrecon-replay` tool for Android supports the following touch controls:

Key(s) | Action
-------|-------
Tap | Toggle pause/play.
Swipe left | Advance to the next frame when paused.

### Key Controls
The `gfxrecon-replay` tool for Android supports the following key controls. Key
events can be simulated through `adb` with the `adb shell input keyevent <key-code>`
command:

Key(s) | Key code(s) | Action
-------|-------------|-------
Space, p | Space = 62, p = 44 |Toggle pause/play.
D-pad right, n | D-pad right = 22, n = 42 | Advance to the next frame when paused.

### Launch Script
The `gfxrecon.py` script, found in the `android/scripts` directory, is provided as
a convenient method for deploying and launching the Android replay tool. The script
currently supports the following commands:

Command | Description
--------|------------
install-apk | Install the specified APK file with the `-g -t -r` options.
replay | Launch the replay tool with the specified command line options.

#### The Install APK Command
The `gfxrecon.py install-apk` command has the following usage:
```
usage: gfxrecon.py install-apk [-h] file

positional arguments:
  file        APK file to install

optional arguments:
  -h, --help  show this help message and exit
```
The command is equivalent to:
```
adb install -g -t -r <file>
```
#### The Replay Command
The `gfxrecon.py replay` command has the following usage:
```
usage: gfxrecon.py replay [-h] [-p local-file] [--version] [--pause-frame N]
                          [--paused] [--sfa] [--opcd] [-m <mode>]
                          [file]

positional arguments:
  file                  File on device to play (forwarded to replay tool)

optional arguments:
  -h, --help            show this help message and exit
  -p local-file, --push-file local-file
                        Local file to push to the location on device specified
                        by <file>
  --version             Print version information and exit (forwarded to
                        replay tool)
  --pause-frame N       Pause after replaying frame number N (forwarded to
                        replay tool)
  --paused              Pause after replaying the first frame (same as "--
                        pause-frame 1"; forwarded to replay tool)
  --sfa, --skip-failed-allocations
                        Skip vkAllocateMemory, vkAllocateCommandBuffers, and
                        vkAllocateDescriptorSets calls that failed during
                        capture (forwarded to replay tool)
  --opcd, --omit-pipeline-cache-data
                        Omit pipeline cache data from calls to
                        vkCreatePipelineCache (forwarded to replay tool)
  -m <mode>, --memory-translation <mode>
                        Enable memory translation for replay on GPUs with
                        memory types that are not compatible with the capture
                        GPU's memory types. Available modes are: none, remap,
                        rebind (forwarded to replay tool)
```

The command accepts all arguments supported by the Desktop version of the replay
tool, with the additional `-p <local-file>, --push-file <local-file>` argument to
push a file from the Desktop system to the Android system before starting the
Android replay activity. The `--push-file` argument is equivalent to:
```
adb push <local-file> <file>
```

The command will force-stop an active replay process before starting the replay
activity with the following:
```
adb shell am force-stop com.lunarg.gfxreconstruct.replay
adb shell am start -n "com.lunarg.gfxreconstruct.replay/android.app.NativeActivity" -a android.intent.action.MAIN -c android.intent.category.LAUNCHER --es "args" "<arg-list>"
```
